/*! 17-01-2015 */
"use strict";angular.module("carDataApp",["util"]),angular.module("util",[]),angular.module("carDataApp").service("drawService",function(){var a=d3.dispatch("tooltipEnter","tooltipExit"),b=function(a){var b=0>a?-a+3:a;return b},c=function(c,e,f){var g=960,h=d3.scale.quantize().range(["#58D3F7","#045FB4","#0B243B"]),i=d(c,f),j=d3.layout.pack().size([g-4,g-4]).value(function(a){return 1+parseInt(b(a.symboling))});h.domain(d3.extent(c,function(a){return parseInt(a.horsepower)}));var k=d3.select(e[0]).append("svg").attr("width",g).attr("height",g).append("g").attr("transform","translate(2,2)"),l=k.selectAll("circle").data(j.nodes(i));l.enter().append("circle").attr("r",function(a){return a.r}).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).style("fill",function(a){return h(parseInt(a.horsepower))}).on("mouseover",function(b,c){a.tooltipEnter(b,c,k)}).on("mouseout",function(b,c){a.tooltipExit(b,c,k)}),l.exit().remove()},d=function(a,b){var c={children:[]};return a.map(function(a){if(c.children.length){var d=!1;angular.forEach(c.children,function(c){c[b]===a[b]&&(c.children.push({carName:a.carName,symboling:a.symboling,horsepower:a.horsepower,price:a.price,children:[]}),d=!0)}),d||c.children.push({carName:a.carName,symboling:a.symboling,horsepower:a.horsepower,price:a.price,children:[]})}else c.children.push({carName:a.carName,symboling:a.symboling,horsepower:a.horsepower,price:a.price,children:[]})}),c},e=function(){d3.selectAll("svg").remove()};return{clearCircles:e,drawPackCircles:c,dispatch:a,convertToSafety:b}}),angular.module("util").service("tooltipService",["$filter",function(a){var b,c;return{init:function(a,d,e,f){function g(a){a.removeClass("n s e w ne nw se sw")}b||(b=d3.tip().attr("class","d3-tip"),b.bgcolor=function(a){return c.css("background-color",a),b},b.css=function(a,d){return arguments[1]?(c.css(a,d),b):c.css(a)},b.appendCls=function(a){return c.addClass(a),b});var h={metric:"",headerFormat:"",bodyFormat:"number",header:a[0]||a,body:a.length>1?a[1]:a};for(var i in h)b[i]=h[i];if(f)for(var j in h)f.hasOwnProperty(j)&&(b[j]=f[j],"function"==typeof f[j]&&(b[j]=f[j].call(null,a)));return c||(c=angular.element(document.querySelector(".d3-tip"))),g(c),e.call(b),b},show:function(d){if(!d){var e=c.offsetWidth||150,f=c.offsetHeight||150,g=b.getbBox();g.e.x<e?b.direction("e").offset([0,10]):screen.width-g.e.x<e?b.direction("w").offset([0,-10]):g.n.y<f?b.direction("s").offset([10,0]):b.direction("n").offset([-10,0])}var h=b.headerFormat.replace(/\s/g,"").split(":")||"",i=b.bodyFormat.replace(/\s/g,"").split(":")||"",j=b.header,k=b.body;h[0]&&(j=h[1]?a(h[0])(b.header,h[1]):a(h[0])(b.header)),i[0]&&(k=i[1]?a(i[0])(b.body,i[1]):a(i[0])(b.body));var l="<div class='graph-tooltip'><div class='graph-label'>"+j+"</div><div class='graph-number'>"+k+" "+b.metric;b.html(l),b.show()},hide:function(){b&&b.hide()}}}]),angular.module("carDataApp").controller("MainCtrl",["$scope","drawService",function(a,b){d3.csv("../data/data.csv").row(function(a){return{symboling:a.symboling,carName:a.make,horsepower:a.horsepower,carType:a.bodyStyle,price:a.price}}).get(function(b,c){a.data=c,a.$digest()}),a.changeVisualizationParameter=function(c,d){$(c.target).siblings(".active").removeClass("active"),b.clearCircles(),b.drawPackCircles(a.data,a.elem,d)}}]),angular.module("carDataApp").directive("bubbleChart",["drawService","tooltipService",function(a,b){return{restrict:"A",controller:"MainCtrl",link:function(c,d){c.$watch("data",function(b){b&&(c.elem=d,a.drawPackCircles(b,d,"carName"))});var e={headerFormat:"",bodyFormat:""};a.dispatch.on("tooltipEnter",function(c,d,f){c.carName&&(e.body="Horsepower: "+c.horsepower+"<br>Safety: "+a.convertToSafety(c.symboling)+"<br>Price: "+c.price,e.header="Car Name: "+c.carName,b.init(c,d,f,e),b.show())}),a.dispatch.on("tooltipExit",function(){b.hide()})}}}]);